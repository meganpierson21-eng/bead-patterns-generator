<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beaded Earring Pattern Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .bead {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: transform 0.1s;
        }
        .bead:hover {
            transform: scale(1.1);
        }
        .tool-btn.selected {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch.selected {
             border-color: #3b82f6;
        }
        .ruler-mark {
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            color: #6b7280; /* gray-500 */
            font-size: 12px;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        input[type="color"] {
        	-webkit-appearance: none;
        	border: none;
        	width: 56px;
        	height: 56px;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
        	padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
        	border: 1px solid #d1d5db;
        	border-radius: 0.5rem; /* rounded-lg */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }

        /* Print-specific styles */
        @media print {
            body {
                padding: 0;
                margin: 0;
            }
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            main {
                display: none !important;
            }
            /* Ensure colors are printed */
            * {
               -webkit-print-color-adjust: exact !important;
               print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 no-print">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-700">Beaded Earring Pattern Generator</h1>
            <p class="text-slate-500 mt-2">Design your own fringe earring patterns with ease.</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Controls Panel -->
            <aside class="w-full lg:w-1/3 xl:w-1/4 bg-white p-6 rounded-2xl shadow-lg">
                <div class="space-y-6">
                    <!-- Image Mapper -->
                    <div>
                        <h2 class="text-lg font-semibold mb-3">Image Reference</h2>
                        <div class="space-y-2">
                            <label for="image-uploader" class="block text-sm font-medium text-slate-600">Upload an image to use as a reference.</label>
                            <input type="file" id="image-uploader" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                        </div>
                    </div>

                    <!-- Color Tools -->
                    <div>
                        <h2 class="text-lg font-semibold mb-3">1. Select a Color</h2>
                        <div class="flex items-center gap-4">
                            <input type="color" id="color-picker" value="#000000">
                            <div class="flex flex-col gap-3">
                                <button id="eyedropper-btn" title="Eyedropper" class="tool-btn p-2 rounded-md border border-slate-300 hover:bg-slate-100 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 2 3.5 3.5L8 13H4v-4L11.5 2z"/><path d="M18 6 22 10"/><path d="M14 16.5 19 21.5"/></svg>
                                </button>
                                <button id="eraser-btn" title="Eraser" class="tool-btn p-2 rounded-md border border-slate-300 hover:bg-slate-100 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0 0 2.828l3.986 3.986a2 2 0 0 0 2.828 0zM2 22l5.5-5.5"/><path d="m15 5 6 6"/></svg>
                                </button>
                            </div>
                        </div>
                        <div id="color-palette" class="grid grid-cols-7 gap-2 mt-4">
                            <!-- Common colors will be injected here -->
                        </div>
                    </div>

                    <!-- Pattern Settings -->
                    <div>
                        <h2 class="text-lg font-semibold mb-3">2. Adjust Pattern Settings</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="top-style" class="block text-sm font-medium text-slate-600">Top Style</label>
                                <select id="top-style" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option value="single" selected>Single Brick (Wide)</option>
                                    <option value="double">Double Brick (Tall)</option>
                                    <option value="none">Loom</option>
                                </select>
                            </div>
                             <div id="loom-shape-container" class="hidden">
                                <label for="loom-shape" class="block text-sm font-medium text-slate-600">Loom Shape</label>
                                <select id="loom-shape" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option value="rectangle" selected>Straight (Rectangle)</option>
                                    <option value="pointed">Pointed Ends</option>
                                </select>
                            </div>
                            <div id="bead-size-container">
                                <label for="bead-size" class="block text-sm font-medium text-slate-600">Bead Size</label>
                                <select id="bead-size" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option value="22">15/0 (Tiny)</option>
                                    <option value="16" selected>11/0 (Standard)</option>
                                    <option value="12">8/0 (Large)</option>
                                    <option value="8">6/0 (Extra Large)</option>
                                </select>
                            </div>
                            <div>
                                <label for="width-input" id="width-label" class="block text-sm font-medium text-slate-600">Width (beads)</label>
                                <input type="number" id="width-input" value="11" min="2" max="25" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                             <div>
                                <label for="length-unit" class="block text-sm font-medium text-slate-600">Length Unit</label>
                                <select id="length-unit" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option value="inches" selected>Inches</option>
                                    <option value="beads">Beads</option>
                                </select>
                            </div>
                            <div>
                                <label for="length-input" id="length-label" class="block text-sm font-medium text-slate-600">Length (inches)</label>
                                <input type="number" id="length-input" value="2" min="0.5" max="50" step="0.1" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div id="fringe-shape-container">
                                <label for="fringe-shape" class="block text-sm font-medium text-slate-600">Fringe Shape</label>
                                <select id="fringe-shape" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option value="rectangle" selected>Rectangle</option>
                                    <option value="v-shape">V-Shape</option>
                                    <option value="chevron">Chevron (Inverted V)</option>
                                </select>
                            </div>
                            <button id="apply-settings" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                                Apply Settings
                            </button>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div>
                        <h2 class="text-lg font-semibold mb-3">3. Actions</h2>
                        <div class="space-y-3">
                             <div class="grid grid-cols-2 gap-3">
                                <button id="save-project-btn" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">Save</button>
                                <label for="load-project-input" class="w-full cursor-pointer bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-600 transition text-center">Load</label>
                                <input type="file" id="load-project-input" class="hidden" accept=".beadpattern">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                 <button id="undo-btn" class="w-full bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition">
                                    Undo
                                </button>
                                 <button id="clear-pattern" class="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">
                                    Clear
                                </button>
                            </div>
                             <button id="trim-btn" class="w-full bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition">
                                Trim
                            </button>
                            <button id="save-image-btn" class="w-full bg-emerald-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition">
                                Save as Image
                            </button>
                             <button id="print-pattern-btn" class="w-full bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition">
                                    Print / PDF
                                </button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main pattern display area -->
            <main class="w-full lg:w-2/3 xl:w-3/4 bg-white p-4 sm:p-6 rounded-2xl shadow-lg overflow-x-auto flex gap-4">
                <div id="pattern-container" class="inline-block">
                    <!-- Pattern will be generated here by JS -->
                </div>
                <div id="image-preview-container" class="hidden">
                     <img id="image-preview" class="max-w-xs h-auto rounded-lg sticky top-4"/>
                </div>
            </main>
        </div>
    </div>

    <!-- This section is only for displaying the pattern for printing/saving -->
    <div id="print-area" class="hidden print-only m-8 bg-white p-4">
        <h1 class="text-2xl font-bold mb-4">Beaded Earring Pattern</h1>
        <div id="pattern-clone-for-print" class="mb-8"></div>
        <h2 class="text-xl font-bold mb-2">Color Key</h2>
        <div id="color-key-for-print"></div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & CONFIG ---
            const commonColors = [
                '#000000', '#FFFFFF', '#A9A9A9', '#FF0000', '#FFA500', '#FFFF00', '#008000', 
                '#0000FF', '#800080', '#FFC0CB', '#964B00', '#40E0D0', '#FFD700', '#C0C0C0'
            ];
            const whiteRgb = 'rgb(255, 255, 255)';
            let activeTool = 'paint';
            let isPainting = false;
            let history = [];
            let uploadedImageSrc = null;

            // --- DOM ELEMENTS ---
            const patternContainer = document.getElementById('pattern-container');
            const colorPicker = document.getElementById('color-picker');
            const paletteContainer = document.getElementById('color-palette');
            const eraserBtn = document.getElementById('eraser-btn');
            const eyedropperBtn = document.getElementById('eyedropper-btn');
            const imageUploader = document.getElementById('image-uploader');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const topStyleSelect = document.getElementById('top-style');
            const loomShapeContainer = document.getElementById('loom-shape-container');
            const loomShapeSelect = document.getElementById('loom-shape');
            const beadSizeContainer = document.getElementById('bead-size-container');
            const beadSizeSelect = document.getElementById('bead-size');
            const widthInput = document.getElementById('width-input');
            const widthLabel = document.getElementById('width-label');
            const lengthUnitSelect = document.getElementById('length-unit');
            const lengthInput = document.getElementById('length-input');
            const lengthLabel = document.getElementById('length-label');
            const fringeShapeContainer = document.getElementById('fringe-shape-container');
            const fringeShapeSelect = document.getElementById('fringe-shape');
            const applySettingsBtn = document.getElementById('apply-settings');
            const clearBtn = document.getElementById('clear-pattern');
            const trimBtn = document.getElementById('trim-btn');
            const printBtn = document.getElementById('print-pattern-btn');
            const saveImageBtn = document.getElementById('save-image-btn');
            const saveProjectBtn = document.getElementById('save-project-btn');
            const loadProjectInput = document.getElementById('load-project-input');
            const undoBtn = document.getElementById('undo-btn');
            const printArea = document.getElementById('print-area');
            const patternCloneForPrint = document.getElementById('pattern-clone-for-print');
            const colorKeyForPrint = document.getElementById('color-key-for-print');

            // --- FUNCTIONS ---

            function setupPalette() {
                paletteContainer.innerHTML = '';
                commonColors.forEach(color => {
                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch';
                    swatch.style.backgroundColor = color;
                    swatch.dataset.color = color;
                    paletteContainer.appendChild(swatch);
                });
            }

            function setActiveTool(tool) {
                activeTool = tool;
                eraserBtn.classList.toggle('selected', tool === 'eraser');
                eyedropperBtn.classList.toggle('selected', tool === 'eyedropper');
                document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));

                if (tool === 'paint') {
                    const currentHex = colorPicker.value.toUpperCase();
                    const matchingSwatch = document.querySelector(`.color-swatch[data-color="${currentHex}"]`);
                    if(matchingSwatch) {
                        matchingSwatch.classList.add('selected');
                    }
                }
                const newCursor = tool === 'eyedropper' ? 'copy' : 'pointer';
                patternContainer.style.cursor = newCursor;
                imagePreview.style.cursor = newCursor;
            }

            function updateUndoButtonState() {
                undoBtn.disabled = history.length === 0;
            }

            function recordAction(bead, oldColor, newColor) {
                if (oldColor === newColor) return;
                history.push({ bead, oldColor, newColor });
                updateUndoButtonState();
            }
            
            function getExistingPatternData() {
                const beadGrid = patternContainer.querySelector('.bead-grid-container');
                if (!beadGrid) return [];

                const rows = Array.from(beadGrid.children).filter(child => child.style.display === 'flex');
                return rows.map(row => {
                    const beads = row.querySelectorAll('.bead');
                    return Array.from(beads).map(bead => bead.style.backgroundColor);
                });
            }

            function generatePattern(applyData = null) {
                const existingData = applyData ? null : getExistingPatternData();

                patternContainer.innerHTML = '';
                
                const topStyle = topStyleSelect.value;
                const widthInBeads = parseInt(widthInput.value);
                const lengthUnit = lengthUnitSelect.value;
                const lengthValue = parseFloat(lengthInput.value);
                const beadsPerInch = parseInt(beadSizeSelect.value);
                const fringeShape = fringeShapeSelect.value;
                const loomShape = loomShapeSelect.value;

                let fringeLengthInBeads;
                if (lengthUnit === 'inches') {
                    fringeLengthInBeads = Math.round(lengthValue * beadsPerInch);
                } else {
                    fringeLengthInBeads = parseInt(lengthValue);
                }

                if (isNaN(widthInBeads) || isNaN(fringeLengthInBeads) || widthInBeads < 2 || fringeLengthInBeads < 1) {
                    patternContainer.innerHTML = '<p class="text-red-500">Please enter valid numbers. Width must be at least 2.</p>';
                    return;
                }

                const mainFlexContainer = document.createElement('div');
                mainFlexContainer.style.display = 'flex';
                mainFlexContainer.style.gap = '8px';

                const rulerContainer = document.createElement('div');
                rulerContainer.className = 'ruler-container';
                rulerContainer.style.display = 'flex';
                rulerContainer.style.flexDirection = 'column';

                const beadGridContainer = document.createElement('div');
                beadGridContainer.className = 'bead-grid-container';
                beadGridContainer.style.display = 'flex';
                beadGridContainer.style.flexDirection = 'column';
                beadGridContainer.style.alignItems = 'center';
                
                if (topStyle !== 'none') {
                    if (topStyle === 'single') {
                        for (let numBeads = 2; numBeads <= widthInBeads; numBeads++) {
                            const row = document.createElement('div');
                            row.style.display = 'flex';
                            rulerContainer.appendChild(createRulerMark(''));
                            for (let j = 0; j < numBeads; j++) { row.appendChild(createBead()); }
                            beadGridContainer.appendChild(row);
                        }
                    } else { // double
                        for (let numBeads = 2; numBeads <= widthInBeads; numBeads++) {
                            for(let k=0; k<2; k++) {
                                const row = document.createElement('div');
                                row.style.display = 'flex';
                                rulerContainer.appendChild(createRulerMark(''));
                                for (let j = 0; j < numBeads; j++) { row.appendChild(createBead()); }
                                beadGridContainer.appendChild(row);
                            }
                        }
                    }
                    const spacer = document.createElement('div');
                    spacer.style.height = '10px';
                    beadGridContainer.appendChild(spacer);
                    const rulerSpacer = document.createElement('div');
                    rulerSpacer.style.height = '10px';
                    rulerContainer.appendChild(rulerSpacer);
                }

                for (let i = 0; i < fringeLengthInBeads; i++) {
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    const label = (i + 1) % 5 === 0 ? (i + 1) : '-';
                    rulerContainer.appendChild(createRulerMark(label));

                    if (topStyle === 'none') {
                        let numBeadsInRow = widthInBeads;
                        if (loomShape === 'pointed') {
                            const minBeads = widthInBeads % 2 === 0 ? 2 : 1;
                            const taperRows = Math.floor((widthInBeads - minBeads) / 2);

                            if (i < taperRows) { // Top taper
                                numBeadsInRow = minBeads + (i * 2);
                            } else if (i >= fringeLengthInBeads - taperRows) { // Bottom taper
                                const bottomRowIndex = fringeLengthInBeads - 1 - i;
                                numBeadsInRow = minBeads + (bottomRowIndex * 2);
                            }
                            if (numBeadsInRow > widthInBeads) numBeadsInRow = widthInBeads;
                        }
                        for (let j = 0; j < numBeadsInRow; j++) { row.appendChild(createBead()); }

                    } else { // Fringe for brick stitch tops
                        for (let j = 0; j < widthInBeads; j++) {
                            const bead = createBead();
                            let isVisible = true;
                            if (fringeShape !== 'rectangle') {
                                const centerColumnIndex = Math.floor(widthInBeads / 2);
                                const distFromCenter = Math.abs(j - centerColumnIndex);
                                let columnLength = fringeLengthInBeads;
                                if (fringeShape === 'v-shape') {
                                    columnLength = fringeLengthInBeads - (centerColumnIndex - distFromCenter);
                                } else if (fringeShape === 'chevron') {
                                    columnLength = fringeLengthInBeads - distFromCenter;
                                }
                                if (i >= columnLength) isVisible = false;
                            }
                            if (!isVisible) {
                                bead.style.visibility = 'hidden';
                                bead.classList.remove('bead');
                            }
                            row.appendChild(bead);
                        }
                    }
                    beadGridContainer.appendChild(row);
                }
                
                mainFlexContainer.appendChild(rulerContainer);
                mainFlexContainer.appendChild(beadGridContainer);
                patternContainer.appendChild(mainFlexContainer);

                const dataToApply = applyData || existingData;
                if (dataToApply) {
                    const newRows = Array.from(beadGridContainer.children).filter(child => child.style.display === 'flex');
                    newRows.forEach((row, rowIndex) => {
                        if (dataToApply[rowIndex]) {
                            const beads = row.querySelectorAll('.bead');
                            beads.forEach((bead, beadIndex) => {
                                if (dataToApply[rowIndex][beadIndex]) {
                                    bead.style.backgroundColor = dataToApply[rowIndex][beadIndex];
                                }
                            });
                        }
                    });
                }
            }

            function createBead() {
                const bead = document.createElement('div');
                bead.className = 'bead bg-white';
                bead.style.backgroundColor = 'white';
                return bead;
            }

            function createRulerMark(text) {
                const mark = document.createElement('div');
                mark.className = 'ruler-mark';
                mark.textContent = text;
                return mark;
            }

            function handleBeadInteraction(e) {
                if (!e.target.classList.contains('bead')) return;
                const bead = e.target;

                if (activeTool === 'eyedropper') {
                    const pickedColor = bead.style.backgroundColor;
                    if (pickedColor !== whiteRgb && pickedColor !== 'white') {
                        colorPicker.value = rgbToHex(pickedColor);
                        setActiveTool('paint');
                    }
                } else {
                    const oldColor = bead.style.backgroundColor;
                    const newColor = activeTool === 'eraser' ? 'white' : colorPicker.value;
                    if (oldColor !== newColor) {
                       bead.style.backgroundColor = newColor;
                       recordAction(bead, oldColor, newColor);
                    }
                }
            }
            
            function clearPattern() {
                const beads = document.querySelectorAll('.bead');
                const changes = [];
                beads.forEach(bead => {
                    if (bead.style.visibility !== 'hidden' && bead.style.backgroundColor !== 'white') {
                       changes.push({bead: bead, oldColor: bead.style.backgroundColor, newColor: 'white'});
                    }
                });
                if (changes.length > 0) history.push(changes);
                beads.forEach(bead => { bead.style.backgroundColor = 'white'; });
                updateUndoButtonState();
            }

            function handleUndo() {
                if (history.length === 0) return;
                const lastAction = history.pop();
                if (Array.isArray(lastAction)) {
                    lastAction.forEach(change => { change.bead.style.backgroundColor = change.oldColor; });
                } else {
                    const { bead, oldColor } = lastAction;
                    bead.style.backgroundColor = oldColor;
                }
                updateUndoButtonState();
            }
            
            function trimEmptyRows() {
                const beadGrid = patternContainer.querySelector('.bead-grid-container');
                const ruler = patternContainer.querySelector('.ruler-container');
                if (!beadGrid || !ruler) return;

                const beadRows = Array.from(beadGrid.children).filter(row => row.style.display === 'flex');
                const rulerRows = Array.from(ruler.children);

                for (let i = beadRows.length - 1; i >= 0; i--) {
                    const row = beadRows[i];
                    const beads = row.querySelectorAll('.bead');
                    const isRowEmpty = Array.from(beads).every(bead => {
                        return bead.style.visibility === 'hidden' || bead.style.backgroundColor === 'white' || bead.style.backgroundColor === whiteRgb;
                    });

                    if (isRowEmpty) {
                        row.remove();
                        if (rulerRows[i]) rulerRows[i].remove();
                    } else {
                        break;
                    }
                }
            }

            function preparePrintArea() {
                patternCloneForPrint.innerHTML = patternContainer.innerHTML;
                const usedColors = new Set();
                document.querySelectorAll('.bead').forEach(bead => {
                    if (bead.style.visibility !== 'hidden' && bead.style.backgroundColor && bead.style.backgroundColor !== 'white' && bead.style.backgroundColor !== whiteRgb) {
                        usedColors.add(bead.style.backgroundColor);
                    }
                });
                let paletteHTML = '';
                usedColors.forEach(color => {
                    paletteHTML += `<div style="display: flex; align-items: center; margin-bottom: 4px;">
                                       <div style="width: 24px; height: 24px; border-radius: 50%; background-color: ${color}; border: 1px solid #ccc; margin-right: 8px;"></div>
                                       <span>${rgbToHex(color).toUpperCase()}</span>
                                    </div>`;
                });
                if (paletteHTML === '') paletteHTML = '<p>No custom colors used.</p>';
                colorKeyForPrint.innerHTML = paletteHTML;
            }

            function printPattern() {
                preparePrintArea();
                window.print();
            }

            function getFormattedTimestamp() {
                const d = new Date();
                const year = d.getFullYear();
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const day = d.getDate().toString().padStart(2, '0');
                const hour = d.getHours().toString().padStart(2, '0');
                const minute = d.getMinutes().toString().padStart(2, '0');
                return `${year}${month}${day}_${hour}${minute}`;
            }

            async function saveAsImage() {
                preparePrintArea();
                saveImageBtn.textContent = 'Saving...';
                saveImageBtn.disabled = true;

                printArea.classList.remove('hidden');
                printArea.style.position = 'absolute';
                printArea.style.left = '-9999px';
                
                try {
                    await new Promise(resolve => setTimeout(resolve, 100));

                    const canvas = await html2canvas(printArea, {
                        useCORS: true, 
                        backgroundColor: '#ffffff',
                        logging: false
                    });
                    
                    const link = document.createElement('a');
                    const timestamp = getFormattedTimestamp();
                    link.download = `bead-pattern_${timestamp}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (error) {
                    console.error('Error saving image:', error);
                    alert('Sorry, could not save the image. Please try again.');
                } finally {
                    printArea.classList.add('hidden');
                    printArea.style.position = '';
                    printArea.style.left = '';
                    saveImageBtn.textContent = 'Save as Image';
                    saveImageBtn.disabled = false;
                }
            }

            function handleTopStyleChange() {
                const isLoom = topStyleSelect.value === 'none';
                loomShapeContainer.classList.toggle('hidden', !isLoom);
                fringeShapeContainer.classList.toggle('hidden', isLoom);
                widthLabel.textContent = isLoom ? 'Width (beads)' : 'Top Width (beads)';
            }

            function handleLengthUnitChange() {
                const unit = lengthUnitSelect.value;
                beadSizeContainer.classList.toggle('hidden', unit === 'beads');
                if (unit === 'inches') {
                    lengthLabel.textContent = 'Length (inches)';
                    lengthInput.step = '0.1';
                    lengthInput.value = '2';
                } else { // beads
                    lengthLabel.textContent = 'Length (beads)';
                    lengthInput.step = '1';
                    lengthInput.value = '30';
                }
            }
            
            function rgbToHex(rgb) {
                if (!rgb || !rgb.startsWith('rgb')) return rgb;
                let [r, g, b] = rgb.match(/\d+/g).map(Number);
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
            }

            function sampleColorFromImage(e) {
                const img = imagePreview;
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0, img.width, img.height);
                
                const rect = img.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const pixel = ctx.getImageData(x, y, 1, 1).data;
                const color = `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;
                
                colorPicker.value = rgbToHex(color);
                setActiveTool('paint');
            }

            function saveProject() {
                const projectData = {
                    settings: {
                        topStyle: topStyleSelect.value,
                        loomShape: loomShapeSelect.value,
                        beadSize: beadSizeSelect.value,
                        width: widthInput.value,
                        lengthUnit: lengthUnitSelect.value,
                        length: lengthInput.value,
                        fringeShape: fringeShapeSelect.value
                    },
                    beadColors: getExistingPatternData()
                };

                const dataStr = JSON.stringify(projectData);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.download = `my-pattern_${getFormattedTimestamp()}.beadpattern`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            }

            function loadProject(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const projectData = JSON.parse(event.target.result);
                        
                        // Restore settings
                        topStyleSelect.value = projectData.settings.topStyle;
                        loomShapeSelect.value = projectData.settings.loomShape;
                        beadSizeSelect.value = projectData.settings.beadSize;
                        widthInput.value = projectData.settings.width;
                        lengthUnitSelect.value = projectData.settings.lengthUnit;
                        lengthInput.value = projectData.settings.length;
                        fringeShapeSelect.value = projectData.settings.fringeShape;

                        // Update UI based on restored settings
                        handleTopStyleChange();
                        handleLengthUnitChange();

                        // Generate the grid and apply colors
                        generatePattern(projectData.beadColors);
                        history = [];
                        updateUndoButtonState();

                    } catch (err) {
                        alert('Could not load the file. It might be corrupted or not a valid pattern file.');
                        console.error("Error loading project:", err);
                    }
                };
                reader.readAsText(file);
                // Clear the input so the same file can be loaded again
                e.target.value = null;
            }

            // --- EVENT LISTENERS ---
            applySettingsBtn.addEventListener('click', generatePattern);
            clearBtn.addEventListener('click', clearPattern);
            undoBtn.addEventListener('click', handleUndo);
            trimBtn.addEventListener('click', trimEmptyRows);
            printBtn.addEventListener('click', printPattern);
            saveImageBtn.addEventListener('click', saveAsImage);
            saveProjectBtn.addEventListener('click', saveProject);
            loadProjectInput.addEventListener('change', loadProject);
            topStyleSelect.addEventListener('change', handleTopStyleChange);
            lengthUnitSelect.addEventListener('change', handleLengthUnitChange);

            imageUploader.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        uploadedImageSrc = event.target.result;
                        imagePreview.src = uploadedImageSrc;
                        imagePreviewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            imagePreview.addEventListener('click', (e) => {
                if (activeTool === 'eyedropper') {
                    sampleColorFromImage(e);
                }
            });

            colorPicker.addEventListener('input', (e) => { setActiveTool('paint'); });
            eraserBtn.addEventListener('click', () => setActiveTool('eraser'));
            eyedropperBtn.addEventListener('click', () => setActiveTool('eyedropper'));

            paletteContainer.addEventListener('click', (e) => {
                if(e.target.classList.contains('color-swatch')) {
                    colorPicker.value = e.target.dataset.color;
                    setActiveTool('paint');
                }
            });

            patternContainer.addEventListener('mousedown', e => {
                isPainting = true;
                handleBeadInteraction(e);
            });
            patternContainer.addEventListener('mouseover', e => {
                if (isPainting && activeTool !== 'eyedropper') {
                    handleBeadInteraction(e);
                }
            });
            document.addEventListener('mouseup', () => { isPainting = false; });
            patternContainer.addEventListener('dragstart', e => e.preventDefault());

            // --- INITIALIZATION ---
            setupPalette();
            generatePattern();
            handleTopStyleChange();
            handleLengthUnitChange();
            setActiveTool('paint');
        });
    </script>
</body>
</html>
